#!!!PERLPATH!!
#
# openisr-config - script to build and install the kernel modules for the
#                  OpenISR (R) system
#
# Copyright (C) 2007-2009 Carnegie Mellon University
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of version 2 of the GNU General Public License as published
# by the Free Software Foundation.  A copy of the GNU General Public License
# should have been distributed along with this program in the file
# LICENSE.GPL.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
#

use strict;
use warnings;
use Term::ANSIColor;
use Getopt::Long;
use constant {
	SHAREDIR => "!!SHAREDIR!!",
	INITSCRIPT => "!!INITDIR!!/openisr",
	VERSION => "!!VERSION!!",
};

my $do_init = 1;

sub fail ($) {
	my $msg = shift;

	print colored("Failed: $msg", "red") . "\n";
	exit 1;
}

sub warning ($) {
	my $msg = shift;

	print colored("Warning: $msg", "yellow") . "\n";
}

sub status ($) {
	my $msg = shift;

	print colored($msg, "green") . "\n";
}


unless (do (SHAREDIR . "/modbuild.pm")) {
	if ($@) {
		fail "Couldn't parse modbuild.pm: $@";
	} else {
		fail "Couldn't load modbuild.pm: $!";
	}
}

fail "Couldn't parse command line"
	unless GetOptions("no-init" => sub {$do_init = 0});

status "Building kernel modules for OpenISR " . VERSION . ".";
print "\n";
fail "You must be root." if $> != 0;

if ($do_init) {
	status "Unloading kernel modules...";
	system(INITSCRIPT . " stop") == 0
		or fail "Couldn't unload kernel modules.\nPlease suspend " .
					"any running parcels and try again.";
}

# The "build" function is defined by modbuild.pm
build();

if ($do_init) {
	status "Loading kernel modules...";
	system(INITSCRIPT . " start") == 0
		or fail "Couldn't load kernel modules";
}

print "\n";
status "Successfully installed OpenISR kernel modules.";
exit 0;
